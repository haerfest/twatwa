#include <stdio.h>
#include "clock.h"
#include "defs.h"
#include "io.h"
#include "memory.h"

#include "cpu.h"

#define SHIFT_S 7
#define SHIFT_Z 6
#define SHIFT_H 4
#define SHIFT_P 2
#define SHIFT_V SHIFT_P
#define SHIFT_N 1
#define SHIFT_C 0

#define FLAG_S (1 << SHIFT_S)
#define FLAG_Z (1 << SHIFT_Z)
#define FLAG_H (1 << SHIFT_H)
#define FLAG_P (1 << SHIFT_P)
#define FLAG_V FLAG_P
#define FLAG_N (1 << SHIFT_N)
#define FLAG_C (1 << SHIFT_C)


/* Indicates bitmask to (not) set FLAG_P for any byte. */
const u8_t parity[256] = {
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00,
  0x04, 0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, 0x04
};


typedef struct {
  /* Normal registers. */
  u8_t a;
  u8_t f;
  u8_t h;
  u8_t l;
  u8_t b;
  u8_t c;
  u8_t d;
  u8_t e;

  /* Shadow registers. */
  u8_t a_;
  u8_t f_;
  u8_t h_;
  u8_t l_;
  u8_t b_;
  u8_t c_;
  u8_t d_;
  u8_t e_;

  /* Index registers. */
  u16_t ix;
  u16_t iy;

  /* Additional registers. */
  u16_t pc;
  u16_t sp;
  u8_t  i;
  u8_t  r;

  /* Hidden registers. */
  u8_t z;
  u8_t w;

  /* Interrupt stuff. */
  int iff1;
  int iff2;
} cpu_t;


/* Local-global cpu for fast reference. */
static cpu_t cpu;


int cpu_init(void) {
  cpu_reset();
  return 0;
}


void cpu_finit(void) {
}


void cpu_reset(void) {
  cpu.iff1 = 0;
  cpu.pc   = 0;
  cpu.i    = 0;
  cpu.r    = 0;
  clock_ticks(3);
}


int cpu_run(u32_t ticks, s32_t* ticks_left) {
  u8_t opcode;

#include "opcodes.c"

  return 0;
}
